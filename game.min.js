"use strict";function Game(e){function t(){var e=Date.now();o=(e-n)/1e3,a.ctx.clearRect(0,0,a.width,a.height),a.ctx.beginPath(),a.ctx.rect(0,0,a.width,a.height),a.ctx.fillStyle="black",a.ctx.fill(),a.update(o),a.render(),n=e,window.requestAnimFrame(t)}function i(e,t){a.eventListeners.forEach(function(i){i.type===e&&i.callback(t)})}GameObject(this),this.canvas=null,this.scenes=[],this.keys=[],this.touch=!1,this.width=e.width||640,this.height=e.height||480,this.messages=[],this.activeScene=-1,this.eventListeners=[];var n=Date.now(),o=0,a=this;this.addScene=function(e){e.parent=this,this.scenes.push(e)},this.addEventListener=function(e,t){this.eventListeners.push({type:e,callback:t})},document.documentElement.requestFullscreen&&document.documentElement.requestFullscreen(),window.addEventListener("load",function(){window.scrollTo(0,1)}),this.init=function(e,i){console.log(this),console.log(a),this.canvas=document.getElementById(e),this.canvas.width=this.width=window.innerWidth,this.canvas.height=this.height=window.innerHeight,this.ctx=this.canvas.getContext("2d"),this.webgl=document.getElementById(i),this.webgl.width=this.width=window.innerWidth,this.webgl.height=this.height=window.innerHeight,this.gl=this.webgl.getContext("webgl")||this.webgl.getContext("experimental-webgl"),this.gl.viewport(0,0,this.webgl.width,this.webgl.height),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0);var o=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,o),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),this.gl.STATIC_DRAW),this.addListener("update",function(e){a.activeScene>=0&&a.scenes[a.activeScene].update(e)}),this.addListener("render",function(e){a.activeScene>=0&&a.scenes[a.activeScene].render()}),n=Date.now(),t()},window.addEventListener("resize",function(){a.canvas.width=window.innerWidth,a.canvas.height=window.innerHeight},!1),document.addEventListener("keydown",function(e){a.keys[e.keyCode]=!0,i("keydown",e)},!1),document.addEventListener("keyup",function(e){a.keys[e.keyCode]=!1,i("keyup",e)},!1),document.addEventListener("touchstart",function(e){a.touch=!0},!1),document.addEventListener("touchend",function(e){a.touch=!1},!1),document.addEventListener("mousedown",function(e){a.mouseEvent=e,a.touch=!0,i("mousedown",e)},!1),document.addEventListener("mouseup",function(e){a.mouseEvent=e,a.touch=!1,i("mouseup",e)},!1),document.addEventListener("mousemove",function(e){i("mousemove",e)},!1)}function entity(e){}function GameObject(e){document.addEventListener("DOMContentLoaded",function(){document.addEventListener("mousedown",function(t){e.triggerListeners("mousedown",t)},!1),document.addEventListener("mouseup",function(t){e.triggerListeners("mouseup",t)},!1),document.addEventListener("mousemove",function(t){e.triggerListeners("mousemove",t)},!1),document.addEventListener("touchstart",function(t){e.triggerListeners("touchstart",t)},!1),document.addEventListener("touchend",function(t){e.triggerListeners("touchend",t)},!1),document.addEventListener("touchmove",function(t){e.triggerListeners("touchmove",t)},!1)})}function Glitch(){GameObject(this),this.position={x:0,y:0},this.dimension={w:16,h:16},this.distance={x:10*Math.random()-5,y:10*Math.random()-5},this.velocity=20*Math.random()+20,this.rotateTo=0,this.angle=0,this.timer=0;var e=this;this.addListener("update",function(t){e.collisionTests&&e.collisionTests.forEach(function(t){if("player"===t.type){var i={x:t.target.position.x,y:t.target.position.y,width:t.target.dimension.w,height:t.target.dimension.h},n={x:e.position.x,y:e.position.y,width:e.dimension.w,height:e.dimension.h};i.x<n.x+n.width&&i.x+i.width>n.x&&i.y<n.y+n.height&&i.height+i.y>n.y&&(t.collision=!0,t.callback(e,t))}if("emp"===t.type){var o={x:t.target.position.x,y:t.target.position.y,r:t.target.bubble.w},a={x:e.position.x,y:e.position.y,w:e.dimension.w,h:e.dimension.h},r=Math.abs(o.x-a.x-a.w/2),s=Math.abs(o.y-a.y-a.h/2);if(r>a.w/2+o.r)return!1;if(s>a.h/2+o.r)return!1;r<=a.w/2&&(t.collision=!0),s<=a.h/2&&(t.collision=!0);var h=r-a.w/2,c=s-a.h/2;t.collision=h*h+c*c<=o.r*o.r,t.collision&&t.callback(e,t)}}),e.timer+=t*e.velocity,parseInt(e.timer)%25===0&&parseInt(e.timer)%50!=0&&(e.distance.x=10*Math.random()-5),parseInt(e.timer)%50===0&&(e.distance.y=10*Math.random()-5);var i=e.distance.x*(t*e.velocity),n=e.distance.y*(t*e.velocity);e.position.x+=i,e.position.y+=n,e.position.x>e.parent.parent.width&&(e.position.x-=2*i),e.position.x<0&&(e.position.x-=2*i),e.position.y>e.parent.parent.height&&(e.position.y-=2*n),e.position.y<0&&(e.position.y-=2*n),e.angle=Math.atan2(e.distance.y,e.distance.x)*(180/Math.PI)}),this.addListener("render",function(){var t=e.parent.parent.ctx;t.save(),t.translate(e.position.x,e.position.y),t.rotate(e.angle*Math.PI/180),t.translate(-e.dimension.w/2,-e.dimension.h/2),t.beginPath(),t.rect(0,0,e.dimension.w,e.dimension.h),t.fillStyle="red",t.fill(),t.restore()})}function Player(){GameObject(this),this.position={x:0,y:0},this.dimension={w:32,h:32},this.velocity=5,this.moving=!1,this.expanding=!1,this.arming=!1,this.exploding=!1,this.colliding=!1,this.timer=0,this.moveTo={x:0,y:0},this.rotateTo=0,this.angle=0,this.life=100,this.bubble={w:0,h:0,vel:1,armed:{w:0,h:0}};var e=this;"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,this.addListener("touchmove",function(t){var i=t.changedTouches;e.moveTo.x=i[0].pageX,e.moveTo.y=i[0].pageY,e.moving=!0,e.exploding||e.arming||(e.exploding=!1,e.arming=!1,e.expanding=!0),t.preventDefault()}),this.addListener("touchstart",function(t){var i=t.changedTouches;e.arming&&(e.moveTo.x=i[0].pageX,e.moveTo.y=i[0].pageY,e.moving=!0),e.expanding=!0}),this.addListener("touchend",function(t){e.bubble.h>32?(e.expanding=!1,this.exploding=!1,e.arming=!0,e.timer=0,e.bubble.armed.w=e.bubble.w,e.bubble.armed.h=e.bubble.h):(e.timer=0,e.expanding=!1,this.exploding=!1,e.arming=!1,e.bubble.armed.w=0,e.bubble.w=0,e.bubble.armed.h=0,e.bubble.h=0)}),this.addListener("update",function(t){if(e.colliding=!1,e.moving){var i=e.moveTo.x-e.position.x,n=e.moveTo.y-e.position.y,o=Math.sqrt(i*i+n*n);o>1?(e.position.x+=i*(t*e.velocity),e.position.y+=n*(t*e.velocity)):e.moving=!1,e.angle=Math.atan2(n,i)*(180/Math.PI)}e.expanding&&e.bubble.h<100&&(e.bubble.w+=32*(t*e.bubble.vel),e.bubble.h+=32*(t*e.bubble.vel)),e.arming&&(e.dimension.w<=64&&(e.dimension.w+=64*(t*e.bubble.vel),e.dimension.h+=64*(t*e.bubble.vel),e.bubble.w+=32*(t*e.bubble.vel),e.bubble.h+=32*(t*e.bubble.vel)),e.timer+=t*e.bubble.vel*2,e.timer>1&&(e.timer=0,e.arming=!1,e.exploding=!0)),e.exploding&&(e.dimension.w=32,e.dimension.h=32,e.bubble.w=e.bubble.armed.w,e.bubble.h=e.bubble.armed.h,e.timer+=t*e.bubble.vel*2,e.timer>1&&(e.timer=0,e.exploding=!1,e.bubble.w=0,e.bubble.h=0))}),this.addListener("render",function(){var t=e.parent.parent.ctx;if(t.save(),t.translate(e.position.x,e.position.y),t.rotate(e.angle*Math.PI/180),t.translate(-e.dimension.w/2,-e.dimension.h/2),t.beginPath(),t.rect(0,0,e.dimension.w,e.dimension.h),t.fillStyle=e.colliding?"red":"white",t.fill(),t.restore(),e.expanding&&(t.globalAlpha=.5,t.beginPath(),t.arc(e.position.x,e.position.y,e.bubble.w,0,2*Math.PI),t.fillStyle="#00CCFF",t.fill(),t.globalAlpha=1),e.arming||e.expanding){t.globalCompositeOperation="overlay";for(var i=0;i<10;i++){t.globalAlpha=1,t.beginPath(),t.strokeStyle="#FFFFFF",t.lineWidth=10;var n=e.bubble.w-Math.random()*e.bubble.w;t.arc(e.position.x,e.position.y,n,n/2,n/2+Math.PI),t.stroke(),t.globalAlpha=1}t.globalCompositeOperation="source-over"}e.arming&&(t.globalAlpha=parseInt(10*e.timer)%2==0?.5:0,t.beginPath(),t.arc(e.position.x,e.position.y,e.bubble.w,0,2*Math.PI),t.fillStyle="#00CCFF",t.fill(),t.globalAlpha=1),e.exploding&&(t.globalAlpha=1-e.timer,t.beginPath(),t.arc(e.position.x,e.position.y,e.bubble.w,0,2*Math.PI),t.fillStyle="#FFFFFF",t.fill(),t.beginPath(),t.strokeStyle="#FFFFFF",t.lineWidth=10,t.arc(e.position.x,e.position.y,e.bubble.w+100*e.timer,0,2*Math.PI),t.stroke(),t.globalAlpha=1)})}function Scene(){GameObject(this),this.entities=[],this.parent=null;var e=this;this.addEntity=function(t){t.parent=e,this.entities.push(t)},this.addListener("update",function(t){e.entities.forEach(function(e){e.update(t)})}),this.addListener("render",function(t){e.entities.forEach(function(e){e.render()})})}function Sprite(e){e={id:0,test:3}.merge(e)}function glCreateShader(e,t,i){var n,o=e.VERTEX_SHADER,a=t;n=e.createShader(o),e.shaderSource(n,a),e.compileShader(n);var r=n;if(DEBUG&&!e.getShaderParameter(n,e.COMPILE_STATUS))throw e.getShaderInfoLog(n);o=e.FRAGMENT_SHADER,a=i,n=e.createShader(o),e.shaderSource(n,a),e.compileShader(n);var s=n;if(DEBUG&&!e.getShaderParameter(n,e.COMPILE_STATUS))throw e.getShaderInfoLog(n);var h=e.createProgram();if(e.attachShader(h,r),e.attachShader(h,s),e.linkProgram(h),DEBUG&&!e.getProgramParameter(h,e.LINK_STATUS))throw e.getProgramInfoLog(h);e.useProgram(h);var c=e.getAttribLocation(h,"p");return e.enableVertexAttribArray(c),e.vertexAttribPointer(c,2,e.FLOAT,!1,0,0),[h]}function glBindShader(e,t){e.useProgram(t[0])}function glUniformLocation(e,t,i){return t[i]||(t[i]=e.getUniformLocation(t[0],i))}function glCreateTexture(e){var t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),t}function glSetTexture(e,t,i){e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i)}function glBindTexture(e,t,i){return e.activeTexture(e.TEXTURE0+i),e.bindTexture(e.TEXTURE_2D,t),i}function glCreateFBO(e,t,i){var n=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,n);var o=glCreateTexture(e);return e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,e.UNSIGNED_BYTE,null),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,o,0),[n,o]}function glBindFBO(e,t){e.bindFramebuffer(e.FRAMEBUFFER,t[0])}function glGetFBOTexture(e){return e[1]}Game.prototype=Object.create(GameObject.prototype),Game.prototype.constructor=Game,window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),GameObject.prototype.render=function(){this.listeners&&this.listeners.forEach(function(e){"render"==e.type&&e.callback()})},GameObject.prototype.update=function(e){this.listeners&&this.listeners.forEach(function(t){"update"==t.type&&t.callback(e)})},GameObject.prototype.addListener=function(e,t){this.listeners||(this.listeners=[]),this.listeners.push({type:e,callback:t})},GameObject.prototype.triggerListeners=function(e,t){this.listeners||(this.listeners=[]),this.listeners.forEach(function(i){i.type==e&&i.callback(t)})},Glitch.prototype=Object.create(GameObject.prototype),Glitch.prototype.constructor=Glitch,Glitch.prototype.addCollisionTest=function(e,t,i){this.collisionTests||(this.collisionTests=[]),this.collisionTests.push({target:e,type:t,callback:i,collision:!1})},Object.prototype.merge=function(e){for(var t in e)try{e[t].constructor==Object?this[t]=this.merge(e[t]):this[t]=e[t]}catch(i){this[t]=e[t]}return this},Player.prototype=Object.create(GameObject.prototype),Player.prototype.constructor=Player,Player.prototype.die=function(){this.dying=!0},Player.prototype.stopExpanding=function(){this.timer=0,this.expanding=!1,this.moving=!1,this.exploding=!1,this.arming=!1,this.bubble.h=0,this.bubble.w=0};var $=new Game({width:window.innerWidth,height:window.innerHeight/2}),menu=new Scene;menu.addListener("update",function(e){menu.parent&&menu.parent.keys[32]&&console.log("[MENU] Space pressed!"),menu.parent&&menu.parent.touch&&console.log("[MENU] Touched!")}),$.addScene(menu);var gameScene=new Scene;gameScene.addListener("update",function(e){gameScene.parent&&gameScene.parent.keys[32]&&console.log("Space pressed!"),gameScene.parent&&gameScene.parent.touch});var player=new Player;player.position={x:$.width/2,y:$.height/2},player.addListener("update",function(e){}),gameScene.addEntity(player);for(var glitches=[],i=0;i<50;i++){var glitch=new Glitch;glitch.position={x:Math.random()*$.width,y:Math.random()*$.height},glitch.addCollisionTest(player,"emp",function(e,t){t.target.exploding&&gameScene.entities.splice(gameScene.entities.indexOf(e),1),t.target.exploding||t.target.arming||(t.target.die(),t.target.expanding=!1,t.target.stopExpanding())}),glitch.addCollisionTest(player,"player",function(e,t){t.target.exploding||t.target.arming||(t.target.die(),t.target.colliding=!0,t.target.life-=.1,console.log(t.target.life))}),gameScene.addEntity(glitch)}$.addScene(gameScene),$.activeScene=1,Scene.prototype=Object.create(GameObject.prototype),Scene.prototype.constructor=Scene;var DEBUG=!0;